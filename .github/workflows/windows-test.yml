name: Windows Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test on Windows
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install WinSCP
        run: choco install winscp -y

      - name: Download SetupRM.exe from SFTP
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_HOST_KEY: ${{ secrets.SFTP_HOST_KEY }}
        run: |
          echo "Downloading SetupRM.exe from SFTP server..."

          # Create WinSCP script
          $scriptFile = New-TemporaryFile
          @"
          option batch abort
          option confirm off
          open sftp://${env:SFTP_HOST} -username=${env:SFTP_USER} -password=${env:SFTP_PASSWORD} -hostkey="${env:SFTP_HOST_KEY}"
          get SetupRM.exe
          exit
          "@ | Out-File -FilePath $scriptFile -Encoding ASCII

          # Run WinSCP
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /script=$scriptFile /loglevel=0
          Remove-Item $scriptFile -Force

          if (Test-Path SetupRM.exe) {
            echo "Download successful!"
            Get-Item SetupRM.exe | Format-List Name, Length, LastWriteTime
          } else {
            echo "Download failed!"
            exit 1
          }

      - name: Run SetupRM.exe
        env:
          PAF_KEY: ${{ secrets.PAF_KEY }}
          PAF_DIRECTORY: ${{ secrets.PAF_DIRECTORY }}
        run: |
          echo "Creating directory..."
          if (-not (Test-Path $env:PAF_DIRECTORY)) {
            New-Item -ItemType Directory -Path $env:PAF_DIRECTORY -Force
          }

          echo "Running SetupRM.exe..."
          $key = $env:PAF_KEY
          $dir = $env:PAF_DIRECTORY
          .\SetupRM.exe /key=$key /directory="$dir"

          echo "SetupRM.exe completed"
