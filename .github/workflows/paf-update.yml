name: PAF Update

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  update:
    name: Update
    runs-on: windows-latest

    steps:
      - name: Generate Month Key
        id: month-key
        run: |
          $monthKey = "Y$(Get-Date -Format 'yy')M$(Get-Date -Format 'MM')"
          echo "month=$monthKey" >> $env:GITHUB_OUTPUT
          echo "Month key: $monthKey"

      - name: Install SFTP Client
        run: choco install winscp -y

      - name: Configure Cache
        id: configure-cache
        uses: actions/cache@v4
        with:
          path: SetupRM.exe
          key: setuprm-${{ steps.month-key.outputs.month }}
          restore-keys: |
            setuprm-

      - name: Download SetupRM.exe
        if: steps.configure-cache.outputs.cache-hit != 'true'
        env:
          SFTP_HOST: ${{ secrets.SFTP_HOST }}
          SFTP_USER: ${{ secrets.SFTP_USER }}
          SFTP_PASSWORD: ${{ secrets.SFTP_PASSWORD }}
          SFTP_HOST_KEY: ${{ secrets.SFTP_HOST_KEY }}
        run: |
          echo "Downloading SetupRM.exe..."

          # Create WinSCP script
          $scriptFile = New-TemporaryFile
          @"
          option batch abort
          option confirm off
          open sftp://${env:SFTP_HOST} -username=${env:SFTP_USER} -password=${env:SFTP_PASSWORD} -hostkey="${env:SFTP_HOST_KEY}"
          get SetupRM.exe
          exit
          "@ | Out-File -FilePath $scriptFile -Encoding ASCII

          # Run WinSCP
          & "C:\Program Files (x86)\WinSCP\WinSCP.com" /script=$scriptFile /loglevel=0
          Remove-Item $scriptFile -Force

          if (Test-Path SetupRM.exe) {
            echo "Download successful!"
            Get-Item SetupRM.exe | Format-List Name, Length, LastWriteTime
          } else {
            echo "Download failed!"
            exit 1
          }

      - name: Run SetupRM.exe
        env:
          PAF_KEY: ${{ secrets.PAF_KEY }}
          PAF_DIRECTORY: ${{ secrets.PAF_DIRECTORY }}
        run: |
          echo "Creating directory..."
          if (-not (Test-Path $env:PAF_DIRECTORY)) {
            New-Item -ItemType Directory -Path $env:PAF_DIRECTORY -Force
          }

          echo "Running SetupRM.exe..."
          $key = $env:PAF_KEY
          $dir = $env:PAF_DIRECTORY
          $process = Start-Process -FilePath ".\SetupRM.exe" -ArgumentList "/key=$key", "/directory=`"$dir`"" -PassThru -Wait -NoNewWindow

          echo "SetupRM.exe completed with exit code: $($process.ExitCode)"

          if ($process.ExitCode -ne 0) {
            echo "ERROR: SetupRM.exe failed with exit code $($process.ExitCode)"
            exit 1
          }

      - name: Verify extracted contents
        env:
          PAF_DIRECTORY: ${{ secrets.PAF_DIRECTORY }}
        run: |
          echo "Listing contents of PAF directory..."
          Get-ChildItem -Path $env:PAF_DIRECTORY | Format-Table Name, Length, LastWriteTime -AutoSize

          echo ""
          $expectedDir = "Y$(Get-Date -Format 'yy')M$(Get-Date -Format 'MM')"
          echo "Checking for $expectedDir directory..."
          if (Test-Path "$env:PAF_DIRECTORY\$expectedDir") {
            echo "$expectedDir directory found!"
            Get-ChildItem -Path "$env:PAF_DIRECTORY\$expectedDir" | Format-Table Name, Length, LastWriteTime -AutoSize
          } else {
            echo "WARNING: $expectedDir directory not found!"
          }
